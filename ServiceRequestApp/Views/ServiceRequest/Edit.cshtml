@using ServiceRequestApp.ViewModels
@model EditServiceRequestViewModel

@{
    ViewData["Title"] = "Edit Service Request";
}

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Service Request</h2>
                </div>
                <div class="card-body p-5">
                    <form asp-action="Edit" asp-route-id="@ViewContext.RouteData.Values["id"]" method="post">
                        @Html.AntiForgeryToken()
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert" style="display: none;"></div>

                        <!-- Service Details Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Service Details
                                </h5>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-8">
                                <label asp-for="Title" class="form-label fw-semibold">
                                    <i class="fas fa-heading me-1"></i>Service Title *
                                </label>
                                <input asp-for="Title" class="form-control form-control-lg" placeholder="Brief description of what you need" />
                                <span asp-validation-for="Title" class="text-danger small"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="CategoryId" class="form-label fw-semibold">
                                    <i class="fas fa-tags me-1"></i>Category *
                                </label>
                                <select asp-for="CategoryId" class="form-control form-control-lg" asp-items="@(new SelectList(Model.Categories, "Id", "Name"))">
                                    <option value="">Select category</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label asp-for="Description" class="form-label fw-semibold">
                                    <i class="fas fa-align-left me-1"></i>Detailed Description *
                                </label>
                                <textarea asp-for="Description" class="form-control form-control-lg" rows="4" placeholder="Provide detailed information about the service you need. Include any specific requirements, materials needed, or special instructions."></textarea>
                                <span asp-validation-for="Description" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Budget and Timeline Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-dollar-sign me-2"></i>Budget & Timeline
                                </h5>
                            </div>
    </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label asp-for="Budget" class="form-label fw-semibold">
                                    <i class="fas fa-money-bill-wave me-1"></i>Budget (৳)
                                </label>
                                <input asp-for="Budget" class="form-control form-control-lg" placeholder="Your budget range" type="number" step="0.01" />
                                <span asp-validation-for="Budget" class="text-danger small"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="BudgetType" class="form-label fw-semibold">
                                    <i class="fas fa-calculator me-1"></i>Budget Type *
                                </label>
                                <select asp-for="BudgetType" class="form-control form-control-lg">
                                    <option value="Negotiable">Negotiable</option>
                                    <option value="Fixed">Fixed Price</option>
                                    <option value="Hourly">Hourly Rate</option>
                                </select>
                                <span asp-validation-for="BudgetType" class="text-danger small"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Urgency" class="form-label fw-semibold">
                                    <i class="fas fa-clock me-1"></i>Urgency *
                                </label>
                                <select asp-for="Urgency" class="form-control form-control-lg">
                                    <option value="Low">Low - Flexible timing</option>
                                    <option value="Medium">Medium - Within a week</option>
                                    <option value="High">High - Within 2-3 days</option>
                                    <option value="Urgent">Urgent - ASAP</option>
        </select>
                                <span asp-validation-for="Urgency" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label asp-for="PreferredDate" class="form-label fw-semibold">
                                    <i class="fas fa-calendar-alt me-1"></i>Preferred Date
                                </label>
                                <input asp-for="PreferredDate" class="form-control form-control-lg" type="date" />
                                <span asp-validation-for="PreferredDate" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Deadline" class="form-label fw-semibold">
                                    <i class="fas fa-calendar-times me-1"></i>Deadline
                                </label>
                                <input asp-for="Deadline" class="form-control form-control-lg" type="date" />
                                <span asp-validation-for="Deadline" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Location Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-map-marker-alt me-2"></i>Service Location
                                </h5>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label asp-for="Street" class="form-label fw-semibold">
                                    <i class="fas fa-road me-1"></i>Street
                                </label>
                                <input asp-for="Street" class="form-control form-control-lg" placeholder="Street/house/apartment" />
                                <span asp-validation-for="Street" class="text-danger small"></span>
                            </div>
                            <div class="col-md-3">
                                <label asp-for="City" class="form-label fw-semibold">
                                    <i class="fas fa-city me-1"></i>City
                                </label>
                                <input asp-for="City" class="form-control form-control-lg" placeholder="City" />
                                <span asp-validation-for="City" class="text-danger small"></span>
                            </div>
                            <div class="col-md-3">
                                <label asp-for="Zipcode" class="form-label fw-semibold">
                                    <i class="fas fa-mail-bulk me-1"></i>Zip Code *
                                </label>
                                <input asp-for="Zipcode" class="form-control form-control-lg" placeholder="Zip code" />
                                <span asp-validation-for="Zipcode" class="text-danger small"></span>
                            </div>
                        </div>
                        <input type="hidden" asp-for="Address" />
                        <input type="hidden" asp-for="Latitude" />
                        <input type="hidden" asp-for="Longitude" />
                        <div class="mb-4">
                            <div id="edit-map" style="height: 320px;" class="rounded border"></div>
                        </div>

                        <!-- Contact Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-phone me-2"></i>Contact Information
                                </h5>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label asp-for="PhoneNumber" class="form-label fw-semibold">
                                    <i class="fas fa-phone me-1"></i>Contact Phone *
                                </label>
                                <input asp-for="PhoneNumber" class="form-control form-control-lg" placeholder="Your contact number" />
                                <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Additional Details Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-clipboard-list me-2"></i>Additional Details
                                </h5>
                            </div>
    </div>

                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label asp-for="SpecialRequirements" class="form-label fw-semibold">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Special Requirements
                                </label>
                                <textarea asp-for="SpecialRequirements" class="form-control form-control-lg" rows="3" placeholder="Any special requirements, access instructions, or additional information providers should know"></textarea>
                                <span asp-validation-for="SpecialRequirements" class="text-danger small"></span>
                            </div>
    </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg w-100 py-3"><i class="fas fa-save me-2"></i>Save Changes</button>
                                <a asp-action="Index" class="btn btn-secondary mt-3">Back to List</a>
                            </div>
    </div>
</form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        $(document).ready(function() {
            // Compose address from parts on submit
            $('form').on('submit', function(e) {
                const street = $('[name="Street"]').val() || '';
                const city = $('[name="City"]').val() || '';
                const zip = $('[name="Zipcode"]').val() || '';
                $('[name="Address"]').val([street, city, zip].filter(Boolean).join(', '));
            });

            // Leaflet picker
            (function(){
                var mapEl = document.getElementById('edit-map');
                if(!mapEl) return;
                var lat = parseFloat(document.querySelector('[name="Latitude"]').value) || 23.777176;
                var lng = parseFloat(document.querySelector('[name="Longitude"]').value) || 90.399452;
                var map = L.map('edit-map').setView([lat, lng], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
                var marker = L.marker([lat, lng], {draggable:true}).addTo(map);
                marker.on('dragend', function(e){ 
                    var p = e.target.getLatLng(); 
                    document.querySelector('[name="Latitude"]').value = p.lat; 
                    document.querySelector('[name="Longitude"]').value = p.lng; 
                });
                map.on('click', function(e){ 
                    marker.setLatLng(e.latlng);
                    document.querySelector('[name="Latitude"]').value = e.latlng.lat; 
                    document.querySelector('[name="Longitude"]').value = e.latlng.lng; 
                });
            })();
        });
    </script>
}